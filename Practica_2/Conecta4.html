<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Conecta 4 WebGL</title>
</head>
<body>
    <canvas id="webglcanvas" style="border: none" width="500" height="500"></canvas>   
    <script id="vs" type="x-shader/x-vertex">
        #version 300 es
        uniform mat4 uMatrizProyeccion;
        uniform mat4 uMatrizVista;
        uniform mat4 uMatrizModelo;

        layout (location = 0) in vec2 aVertices; 
        layout (location = 1) in vec4 aColores; 

        out vec4 vColores;

        void main() {
            vColores = aColores;
            gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
        }
    </script>

    <script id="fs" type="x-shader/x-fragment">
        #version 300 es
        precision mediump float;

        in vec4 vColores;
        out vec4 color;

        void main() {
            color = vColores;
        }
    </script>

    <script>
        let gl, canvas;
        let uMatrizProyeccion, uMatrizVista, uMatrizModelo;
        let MatrizProyeccion = new Array(16);
        let MatrizVista = new Array(16);
        let MatrizModelo = new Array(16);

        let vaoCirculo, vaoBoton;
        let tablero = Array.from({length:7},()=>Array(6).fill(null));
        let fichasAnimando = [];
        let turnoRojo = true;

        // ================== MATRICES =====================
        function identidad(r) {
          r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = 0;
          r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = 0;
          r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0;
          r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
        }
        function traslacion(matriz, tx, ty, tz) {
          let r = new Array(16);
          r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = tx;
          r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = ty;
          r[2] = 0; r[6] = 0; r[10] = 1; r[14] = tz;
          r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
          multiplica(matriz, matriz, r);
        }
        function ortho(r, izq, der, abj, arr, cerca, lejos) {
          r[0] = 2/(der - izq); r[4] = 0; r[8]  = 0; r[12] = -(der + izq)/(der - izq);
          r[1] = 0; r[5] = 2/(arr - abj); r[9]  = 0; r[13] = -(arr + abj)/(arr - abj);
          r[2] = 0; r[6] = 0; r[10] = -2/(lejos - cerca); r[14] = -(lejos + cerca)/(lejos - cerca);
          r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
        }
        function multiplica(c, a, b) {
          let r = new Array(16);
          for (let i = 0; i < 4; i++){
            for (let j = 0; j < 4; j++){
              let s = 0;
              for (let k = 0; k < 4; k++)
                s += a[i + k * 4] * b[k + j * 4];
              r[i + j * 4] = s;
            }
          }
          for (let i = 0; i < 16; i++) c[i] = r[i];
        }

        function crearCirculo(radio, r,g,b){
            let vertices=[0,0];
            let colores=[r,g,b,1];
            for(let i=0;i<=360;i++){
                let ang=i*Math.PI/180;
                vertices.push(radio*Math.cos(ang));
                vertices.push(radio*Math.sin(ang));
                colores.push(r,g,b,1);
            }
            let vao=gl.createVertexArray();
            gl.bindVertexArray(vao);

            let vbo=gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER,vbo);
            gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);

            let cbo=gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER,cbo);
            gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(colores),gl.STATIC_DRAW);
            gl.enableVertexAttribArray(1);
            gl.vertexAttribPointer(1,4,gl.FLOAT,false,0,0);

            gl.bindVertexArray(null);
            return vao;
        }

        function crearRectangulo(ancho, alto, r, g, b) {
            let vertices = [
                -ancho/2, -alto/2,
                 ancho/2, -alto/2,
                 ancho/2,  alto/2,
                -ancho/2,  alto/2
            ];
            let colores = [
                r,g,b,1, r,g,b,1, r,g,b,1, r,g,b,1
            ];
            let vao = gl.createVertexArray();
            gl.bindVertexArray(vao);

            let vboVertices = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, vboVertices);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            let vboColores = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, vboColores);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colores), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(1);
            gl.vertexAttribPointer(1, 4, gl.FLOAT, false, 0, 0);

            gl.bindVertexArray(null);
            return vao;
        }

        function soltarFicha(col) {
            let columnaOcupada = false;
            for (let i = 0; i < fichasAnimando.length; i++) {
                if (fichasAnimando[i].col === col) {
                    columnaOcupada = true;
                    break; 
                }
            }
            if (columnaOcupada) {
                return;
            }

            let fila = tablero[col].lastIndexOf(null); 
            if (fila === -1) return; 

            let color;
            if (turnoRojo) {
                color = [1, 0, 0];
            } else {
                color = [0, 0, 1];
            }
            turnoRojo = !turnoRojo;

            fichasAnimando.push({
                col: col,
                fila: fila,
                yActual: 3,
                color: color
            });
        }

        function dibujarTablero(){
            gl.clear(gl.COLOR_BUFFER_BIT);

            // cÃ­rculos
            let b=-3;
            for(let j=0;j<7;j++){
                let a=2;
                for(let i=0;i<6;i++){
                    identidad(MatrizModelo);
                    traslacion(MatrizModelo, b, a, 0);
                    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
                    gl.bindVertexArray(vaoCirculo);
                    gl.drawArrays(gl.TRIANGLE_FAN,0,362);
                    a=a-1;
                }
                // rectangulo
                identidad(MatrizModelo);
                traslacion(MatrizModelo, b, 3, 0);
                gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
                gl.bindVertexArray(vaoBoton);
                gl.drawArrays(gl.TRIANGLE_FAN,0,4);
                b=b+1;
            }

            for(let c=0;c<7;c++){
                for(let f=0;f<6;f++){
                    if(tablero[c][f]!==null){
                        let [r,g,b,a]=tablero[c][f];
                        let vaoFicha = crearCirculo(0.45,r,g,b);
                        identidad(MatrizModelo);
                        traslacion(MatrizModelo,-3+c,2-f,0);
                        gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
                        gl.bindVertexArray(vaoFicha);
                        gl.drawArrays(gl.TRIANGLE_FAN,0,362);
                    }
                }
            }

            for (let i = fichasAnimando.length - 1; i >= 0; i--) {
                let ficha = fichasAnimando[i];
                ficha.yActual -= 0.05;
                let yDestino = 2 - ficha.fila;
                if (ficha.yActual <= yDestino) {
                    ficha.yActual = yDestino;
                    tablero[ficha.col][ficha.fila] = ficha.color;
                    fichasAnimando.splice(i, 1); 
                }
                let vaoFicha = crearCirculo(0.45, ficha.color[0], ficha.color[1], ficha.color[2]);
                identidad(MatrizModelo);
                traslacion(MatrizModelo, -3 + ficha.col, ficha.yActual, 0);
                gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
                gl.bindVertexArray(vaoFicha);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, 362);
            }

        }

        function animar(){
            dibujarTablero();
            requestAnimationFrame(animar);
        }

        function main(){
            canvas=document.getElementById("webglcanvas");
            gl=canvas.getContext("webgl2");

            // Shaders
            let vs=gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vs,document.getElementById("vs").text.trim());
            gl.compileShader(vs);

            let fs=gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fs,document.getElementById("fs").text.trim());
            gl.compileShader(fs);

            let prog=gl.createProgram();
            gl.attachShader(prog,vs);
            gl.attachShader(prog,fs);
            gl.linkProgram(prog);
            gl.useProgram(prog);

            uMatrizProyeccion=gl.getUniformLocation(prog,"uMatrizProyeccion");
            uMatrizVista=gl.getUniformLocation(prog,"uMatrizVista");
            uMatrizModelo=gl.getUniformLocation(prog,"uMatrizModelo");

            vaoCirculo = crearCirculo(0.45,1,1,1); 
            vaoBoton   = crearRectangulo(0.9,0.3,0.2,0.2,0.8);

            ortho(MatrizProyeccion,-4,4,-4,4,-1,1);
            gl.uniformMatrix4fv(uMatrizProyeccion,false,MatrizProyeccion);
            identidad(MatrizVista);
            gl.uniformMatrix4fv(uMatrizVista,false,MatrizVista);

            gl.clearColor(0,0,0.3,1);
            gl.viewport(0,0,canvas.width,canvas.height);

            canvas.addEventListener("mousedown",mouseDown,false);
            animar();
        }

        function mouseDown(e){
            let posx=e.x-canvas.offsetLeft;
            let posy=e.y-canvas.offsetTop;
            let x=(posx*8)/500-4;
            let y=(4-(posy*8)/500);

            for(let col=0;col<7;col++){
                let cx=-3+col;
                if(x>cx-0.45 && x<cx+0.45 && y>2.8 && y<3.2){
                    soltarFicha(col);
                }
            }
        }

        window.onload=main;
    </script>
</body>
</html>
