<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Conecta 4 WebGL simple</title>
</head>
<body>
<canvas id="webglcanvas" width="500" height="500"></canvas>

<script id="vs" type="x-shader/x-vertex">
#version 300 es
uniform mat4 uMatrizProyeccion;
uniform mat4 uMatrizVista;
uniform mat4 uMatrizModelo;

layout (location = 0) in vec2 aVertices; 
layout (location = 1) in vec4 aColores; 

out vec4 vColores;

void main() {
    vColores = aColores;
    gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
}
</script>

<script id="fs" type="x-shader/x-fragment">
#version 300 es
precision mediump float;

in vec4 vColores;
out vec4 color;

void main() {
    color = vColores;
}
</script>

<script>
let gl, canvas;
let uMatrizProyeccion, uMatrizVista, uMatrizModelo;
let MatrizProyeccion = new Array(16);
let MatrizVista = new Array(16);
let MatrizModelo = new Array(16);

let vaoCirculo;
let tablero = [];
let turnoRojo = true;

// ===== MATRICES =====
function identidad(r) {
  r[0]=1; r[4]=0; r[8]=0; r[12]=0;
  r[1]=0; r[5]=1; r[9]=0; r[13]=0;
  r[2]=0; r[6]=0; r[10]=1; r[14]=0;
  r[3]=0; r[7]=0; r[11]=0; r[15]=1;
}
function traslacion(m,tx,ty,tz){
  let r=[1,0,0,0, 0,1,0,0, 0,0,1,0, tx,ty,tz,1];
  multiplica(m,m,r);
}
function ortho(r,izq,der,abj,arr,cerca,lejos){
  r[0]=2/(der-izq); r[4]=0; r[8]=0; r[12]=-(der+izq)/(der-izq);
  r[1]=0; r[5]=2/(arr-abj); r[9]=0; r[13]=-(arr+abj)/(arr-abj);
  r[2]=0; r[6]=0; r[10]=-2/(lejos-cerca); r[14]=-(lejos+cerca)/(lejos-cerca);
  r[3]=0; r[7]=0; r[11]=0; r[15]=1;
}
function multiplica(c,a,b){
  let r=new Array(16);
  for(let i=0;i<4;i++){
    for(let j=0;j<4;j++){
      let s=0;
      for(let k=0;k<4;k++) s+=a[i+k*4]*b[k+j*4];
      r[i+j*4]=s;
    }
  }
  for(let i=0;i<16;i++) c[i]=r[i];
}

// ===== FIGURAS =====
function crearCirculo(radio,r,g,b){
    let vertices=[0,0];
    let colores=[r,g,b,1];
    for(let i=0;i<=360;i++){
        let ang=i*Math.PI/180;
        vertices.push(radio*Math.cos(ang));
        vertices.push(radio*Math.sin(ang));
        colores.push(r,g,b,1);
    }
    let vao=gl.createVertexArray();
    gl.bindVertexArray(vao);

    let vbo=gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER,vbo);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);
    gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);

    let cbo=gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER,cbo);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(colores),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(1);
    gl.vertexAttribPointer(1,4,gl.FLOAT,false,0,0);

    gl.bindVertexArray(null);
    return vao;
}

function dibujarTablero(){
    gl.clear(gl.COLOR_BUFFER_BIT);

    let b=-3;
    for(let col=0;col<7;col++){
        let a=2;
        for(let fila=0;fila<6;fila++){
            identidad(MatrizModelo);
            traslacion(MatrizModelo,b,a,0);

            let color=tablero[col][fila];
            let vaoFicha;
            if(color===null){
                vaoFicha=crearCirculo(0.45,1,1,1); // blanco
            } else {
                vaoFicha=crearCirculo(0.45,color[0],color[1],color[2]);
            }

            gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
            gl.bindVertexArray(vaoFicha);
            gl.drawArrays(gl.TRIANGLE_FAN,0,362);
            a=a-1;
        }
        b=b+1;
    }
}

// ===== MAIN =====
function main(){
    canvas=document.getElementById("webglcanvas");
    gl=canvas.getContext("webgl2");

    // shaders
    let vs=gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vs,document.getElementById("vs").text.trim());
    gl.compileShader(vs);
    let fs=gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fs,document.getElementById("fs").text.trim());
    gl.compileShader(fs);

    let prog=gl.createProgram();
    gl.attachShader(prog,vs);
    gl.attachShader(prog,fs);
    gl.linkProgram(prog);
    gl.useProgram(prog);

    uMatrizProyeccion=gl.getUniformLocation(prog,"uMatrizProyeccion");
    uMatrizVista=gl.getUniformLocation(prog,"uMatrizVista");
    uMatrizModelo=gl.getUniformLocation(prog,"uMatrizModelo");

    vaoCirculo=crearCirculo(0.45,1,1,1);

    ortho(MatrizProyeccion,-4,4,-4,4,-1,1);
    gl.uniformMatrix4fv(uMatrizProyeccion,false,MatrizProyeccion);
    identidad(MatrizVista);
    gl.uniformMatrix4fv(uMatrizVista,false,MatrizVista);

    gl.clearColor(0,0,0.3,1);
    gl.viewport(0,0,canvas.width,canvas.height);

    // inicializar tablero vacÃ­o
    for(let i=0;i<7;i++){
        let columna=[];
        for(let j=0;j<6;j++){
            columna.push(null);
        }
        tablero.push(columna);
    }

    canvas.addEventListener("mousedown",mouseDown,false);
    dibujarTablero();
}

function mouseDown(e){
    let posx=e.x-canvas.offsetLeft;
    let posy=e.y-canvas.offsetTop;
    let x=(posx*8)/500-4;
    let y=(4-(posy*8)/500);

    let col=Math.floor(x+3.5);  
    let fila=Math.floor(2.5-y); 

    if(col>=0 && col<7 && fila>=0 && fila<6){
        if(tablero[col][fila]===null){
            let color;
        if (turnoRojo) {
            color = [1, 0, 0]; 
        } else {
            color = [0, 0, 1]; 
        }

        tablero[col][fila] = color;

            turnoRojo=!turnoRojo;
        }
    }
    dibujarTablero();
}

window.onload=main;
</script>
</body>
</html>
